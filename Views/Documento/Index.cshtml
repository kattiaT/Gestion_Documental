@{
    ViewData["Title"] = "Demo Google Docs";
}

<h2>Demo: Gestión Documental con Google Drive</h2>

<button id="pickerBtn" class="btn btn-primary">Seleccionar documento</button>
<br /><br />

<iframe id="docFrame" src="" width="100%" height="600" style="border:1px solid #ccc;"></iframe>

@section Scripts {
    <script src="https://apis.google.com/js/api.js"></script>
    <script>
        let authToken;
        let pickerApiLoaded = false;

        function onApiLoad() {
            gapi.load('auth', { 'callback': onAuthApiLoad });
            gapi.load('picker', { 'callback': onPickerApiLoad });
        }

        function onAuthApiLoad() {
            window.gapi.auth.authorize({
                client_id: '303826226951-9df1v77pn5lvlg72ljk13uleeeqvrjfd.apps.googleusercontent.com',
                scope: ['https://www.googleapis.com/auth/drive.readonly'],
                immediate: false
            }, handleAuthResult);
        }

        function handleAuthResult(authResult) {
            if (authResult && !authResult.error) {
                authToken = authResult.access_token;
                createPicker();
            } else {
                alert("Error de autenticación: " + authResult.error);
            }
        }

        function onPickerApiLoad() {
            pickerApiLoaded = true;
        }

        function createPicker() {
            if (pickerApiLoaded && authToken) {
                const picker = new google.picker.PickerBuilder()
                    .addView(google.picker.ViewId.DOCUMENTS)
                    .setOAuthToken(authToken)
                    .setDeveloperKey('AIzaSyCZGJV0liueX_qRCnfOr5__2sstwyQa_qk')
                    .setCallback(pickerCallback)
                    .build();
                picker.setVisible(true);
            } else {
                alert("Error: Picker API no está cargado o no hay token de autenticación.");
            }
        }

        function pickerCallback(data) {
            if (data[google.picker.Response.ACTION] === google.picker.Action.PICKED) {
                const fileId = data[google.picker.Response.DOCUMENTS][0][google.picker.Document.ID];
                const url = `https://docs.google.com/document/d/${fileId}/edit?embedded=true`;
                document.getElementById('docFrame').src = url;
            } else if (data[google.picker.Response.ACTION] === google.picker.Action.CANCEL) {
                alert("Selección cancelada.");
            }
        }

        document.getElementById('pickerBtn').addEventListener('click', () => {
            onApiLoad();
        });
    </script>
}
